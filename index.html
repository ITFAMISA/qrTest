<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Escáner QR para Empleados</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        body {
            background-color: #f3f4f6;
            font-family: 'Inter', sans-serif;
        }
        .card {
            background-color: white;
            padding: 2.5rem;
            border-radius: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            max-width: 400px;
            width: 90%;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        #qr-reader {
            width: 100%;
        }
        .success-message {
            background-color: #d1fae5;
            color: #065f46;
        }
        .error-message {
            background-color: #fee2e2;
            color: #b91c1c;
        }
        .employee-data {
            text-align: left;
        }
        .employee-data h3 {
            font-weight: 700;
            font-size: 1.5rem;
            color: #111827;
        }
        .employee-data p {
            margin-top: 0.5rem;
            color: #4b5563;
        }
        .button {
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            border-radius: 0.75rem;
            transition: background-color 0.3s ease-in-out, transform 0.2s ease-in-out;
            cursor: pointer;
            border: none;
        }
        .button-primary {
            background-color: #2563eb;
            color: white;
        }
        .button-primary:hover {
            background-color: #1d4ed8;
            transform: translateY(-2px);
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div class="card">
        <h1 class="text-2xl font-bold text-gray-900">Escáner de QR</h1>
        <p class="text-gray-500">Haz clic para escanear tu código de ficha.</p>
        
        <!-- Contenedor del escáner -->
        <div id="qr-reader" style="display: none;"></div>

        <!-- Selector de cámara -->
        <select id="camera-select" class="hidden border rounded-lg p-2"></select>
        
        <!-- Botón de escaneo -->
        <button id="scan-button" class="button button-primary">
            Escanear Ficha
        </button>

        <!-- Resultado -->
        <div id="result-message" class="hidden"></div>
    </div>

    <script>
        const qrCode = document.getElementById('qr-reader');
        const scanButton = document.getElementById('scan-button');
        const resultMessage = document.getElementById('result-message');
        const cameraSelect = document.getElementById('camera-select');

        // Base de datos ficticia de empleados
        const employeeData = {
            'a3f4b2c9d1e6f7089b2c4d5e6f7a8b1c': { nombre: 'JORGE NAVARRO', puesto: 'SUPERVISOR', ficha: 456 },
            '9f8e7d6c5b4a39281716f0e1d2c3b4f0': { nombre: 'VICTOR GARCIA', puesto: 'SUPERVISOR', ficha: 2119 },
            '0123456789abcdef0123456789abcdef': { nombre: 'JOSE DOLORES MF270', puesto: 'SUPERVISOR', ficha: 548 },
            'fedcba9876543210fedcba9876543210': { nombre: 'FERNANDO NAJERA', puesto: 'TEAM LEADER', ficha: 1628 },
            '1a2b3c4d5e6f708192a3b4c5d6e7f809': { nombre: 'JESUS SEGURA', puesto: 'SUPERVISOR', ficha: 1629 },
            'c0ffee1234567890deadbeefcafebabe': { nombre: 'JUAN MONCAYO', puesto: 'SUPERVISOR', ficha: 1896 },
            '89ab67cd45ef0123a1b2c3d4e5f60718': { nombre: 'CARLOS NAVARRO', puesto: 'SUPERVISOR', ficha: 1836 },
            '7e6d5c4b3a2918171625344556677889': { nombre: 'CARLOS GRIMALDO', puesto: 'SUPERVISOR', ficha: 894 },
            'deadc0debeadfeedcafebabefaceb00c': { nombre: 'RICARDO ELI', puesto: 'SUPERVISOR', ficha: 1361 },
            'ab12cd34ef56ab78cd90ef12ab34cd56': { nombre: 'ABDIEL GUTIERREZ', puesto: 'SUPERVISOR', ficha: 2450 },
            '33445566778899aabbccddeeff001122': { nombre: 'Jose Luis Valdez cuellar', puesto: 'SUPERVISOR', ficha: 461 },
            '5566778899aabbccddeeff0011223344': { nombre: 'Jose Luis Valdez menchaca', puesto: 'SUPERVISOR', ficha: 205 }
        };

        let html5QrCode = null;

        // Escucha el botón de escaneo
        scanButton.addEventListener('click', () => {
            if (html5QrCode && html5QrCode._isScanning) {
                html5QrCode.stop().then(() => {
                    qrCode.style.display = 'none';
                    cameraSelect.classList.add('hidden');
                    scanButton.textContent = 'Escanear Ficha';
                    resultMessage.classList.add('hidden');
                });
            } else {
                Html5Qrcode.getCameras().then(devices => {
                    if (devices && devices.length) {
                        // Mostrar selector de cámaras
                        cameraSelect.innerHTML = "";
                        devices.forEach(device => {
                            const option = document.createElement("option");
                            option.value = device.id;
                            option.text = device.label || `Cámara ${device.id}`;
                            cameraSelect.appendChild(option);
                        });
                        cameraSelect.classList.remove('hidden');

                        // Usar la cámara seleccionada
                        const cameraId = cameraSelect.value;
                        html5QrCode = new Html5Qrcode("qr-reader");
                        qrCode.style.display = 'block';
                        scanButton.textContent = 'Detener Escáner';

                        const config = { fps: 10, qrbox: 250 };
                        html5QrCode.start({ deviceId: { exact: cameraId } }, config, onScanSuccess, onScanFailure)
                            .catch(err => {
                                console.error("Error al iniciar el escáner:", err);
                                resultMessage.className = 'block mt-6 p-4 rounded-xl text-center error-message';
                                resultMessage.innerHTML = 'Error al acceder a la cámara. Asegúrate de dar los permisos.';
                                qrCode.style.display = 'none';
                                scanButton.textContent = 'Escanear Ficha';
                            });

                        // Si cambias la cámara en el select, reinicia el escáner
                        cameraSelect.addEventListener('change', () => {
                            html5QrCode.stop().then(() => {
                                html5QrCode.start(
                                    { deviceId: { exact: cameraSelect.value } },
                                    config,
                                    onScanSuccess,
                                    onScanFailure
                                );
                            });
                        });
                    }
                }).catch(err => {
                    console.error("No se pudieron obtener las cámaras:", err);
                });
            }
        });

        function onScanSuccess(decodedText) {
            const regex = /[?&]id=([^&]+)/;
            const match = decodedText.match(regex);
            let id = match && match[1] ? match[1] : decodedText.trim();

            if (employeeData[id]) {
                const empleado = employeeData[id];
                resultMessage.className = 'block mt-6 p-4 rounded-xl text-center success-message';
                resultMessage.innerHTML = `
                    <div class="employee-data">
                        <h3 class="text-xl font-semibold">¡Bienvenido!</h3>
                        <p class="mt-2 text-gray-700">Has iniciado sesión como:</p>
                        <ul class="mt-2 text-left list-disc list-inside">
                            <li><strong>Nombre:</strong> ${empleado.nombre}</li>
                            <li><strong>Ficha:</strong> ${empleado.ficha}</li>
                            <li><strong>Puesto:</strong> ${empleado.puesto}</li>
                        </ul>
                    </div>
                `;
            } else {
                resultMessage.className = 'block mt-6 p-4 rounded-xl text-center error-message';
                resultMessage.innerHTML = 'Identificador no válido o no encontrado. Por favor, escanea tu ficha de nuevo.';
            }

            // Detener después de leer un QR
            html5QrCode.stop().then(() => {
                qrCode.style.display = 'none';
                scanButton.textContent = 'Escanear Ficha';
                resultMessage.classList.remove('hidden');
            });
        }

        function onScanFailure(error) {
            // Aquí podrías mostrar un log, pero no es necesario
        }
    </script>
</body>
</html>
