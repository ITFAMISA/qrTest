<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Escáner QR</title>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      text-align: center;
    }
    #qr-reader {
      width: 300px;
      margin: auto;
    }
    .camera-list {
      margin-top: 20px;
      text-align: left;
      display: inline-block;
    }
    .camera-item {
      font-size: 14px;
      margin-bottom: 5px;
      padding: 4px;
      border-bottom: 1px solid #ccc;
    }
    #camera-info {
      margin-top: 10px;
      font-size: 14px;
      color: #444;
    }
    .error-message {
      color: red;
      margin-top: 15px;
    }
  </style>
</head>
<body>
  <h2>Escáner de Código QR</h2>
  <button id="scanButton">Escanear Ficha</button>

  <div id="qr-reader" style="display:none; margin-top:20px;"></div>
  <p id="camera-info" class="hidden"></p>
  <div id="camera-list" class="camera-list"></div>
  <p id="resultMessage" class="hidden"></p>

  <script>
    const scanButton = document.getElementById("scanButton");
    const qrCode = document.getElementById("qr-reader");
    const resultMessage = document.getElementById("resultMessage");
    const camInfo = document.getElementById("camera-info");
    const camList = document.getElementById("camera-list");

    let html5QrCode = null;

    function onScanSuccess(decodedText, decodedResult) {
      resultMessage.textContent = "Código detectado: " + decodedText;
      resultMessage.className = "block";
    }

    function onScanFailure(error) {
      console.warn("Fallo al escanear:", error);
    }

    scanButton.addEventListener("click", () => {
      if (html5QrCode && html5QrCode._isScanning) {
        html5QrCode.stop().then(() => {
          qrCode.style.display = "none";
          scanButton.textContent = "Escanear Ficha";
          resultMessage.className = "hidden";
          camInfo.textContent = "";
          camList.innerHTML = "";
        });
      } else {
        html5QrCode = new Html5Qrcode("qr-reader");

        Html5Qrcode.getCameras().then(cameras => {
          if (cameras && cameras.length) {
            // Mostrar todas las cámaras detectadas
            camList.innerHTML = "<h3>Cámaras detectadas:</h3>";
            cameras.forEach((cam, index) => {
              const item = document.createElement("div");
              item.className = "camera-item";
              item.textContent = `${index + 1}. ID: ${cam.id} | Label: ${cam.label}`;
              camList.appendChild(item);
            });

            // Buscar cámara trasera
            let backCamera = cameras.find(cam => cam.label.toLowerCase().includes("back"));
            let cameraId = backCamera ? backCamera.id : cameras[0].id;

            camInfo.textContent = `Usando cámara: ${cameraId}`;

            qrCode.style.display = "block";
            scanButton.textContent = "Detener Escáner";

            const config = { fps: 10, qrbox: 250 };
            html5QrCode.start(cameraId, config, onScanSuccess, onScanFailure)
              .catch(err => {
                console.error("Error al iniciar cámara:", err);
                resultMessage.className = "error-message";
                resultMessage.textContent = "No se pudo iniciar la cámara.";
                qrCode.style.display = "none";
                scanButton.textContent = "Escanear Ficha";
              });
          } else {
            resultMessage.className = "error-message";
            resultMessage.textContent = "No se detectaron cámaras en este dispositivo.";
          }
        }).catch(err => {
          console.error("Error obteniendo cámaras:", err);
        });
      }
    });
  </script>
</body>
</html>
